<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>974DR ‚Äî Calcul mental</title>

  <!-- Ic√¥ne & PWA -->
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0e0f12">

  <style>
/* Ligne "Vive les maths" ‚Äî pop + battement */
.intro-heart{
  font-size: clamp(18px, 4vw, 26px);
  color:#ff4d4d;
  font-weight: 800;
  letter-spacing: .5px;
  text-shadow: 0 0 12px rgba(255,77,77,.35);
  animation:
    heartPop .9s cubic-bezier(.2,.9,.2,1) .15s both,
    heartBeat 1.6s ease-in-out .9s 6 alternate;
}
@keyframes heartPop{ from{transform:scale(.85);opacity:0} to{transform:scale(1);opacity:1} }
@keyframes heartBeat{ 0%{transform:scale(1)} 30%{transform:scale(1.08)} 60%{transform:scale(1)} 100%{transform:scale(1.06)} }

@media (prefers-reduced-motion: reduce){ .intro-heart{ animation:none } }
:root{ --bg:#0e0f12; --card:#171a21; --text:#e8ecf1; --muted:#aab3bd; --accent:#ffd166; --ok:#34d399; --bad:#f87171; --border:rgba(255,255,255,.1); }
*{box-sizing:border-box}
html,body{height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}

.wrap{max-width:980px;margin:28px auto 64px;padding:0 16px}
header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
header .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#4aa7ff,#9b72ff);display:grid;place-items:center}
header .logo span{font-weight:800;color:white;font-size:20px}
h1{margin:0;font-size:clamp(22px,4vw,34px)}
.sub{color:var(--muted);font-size:14px}

.banner{background:linear-gradient(135deg,#4aa7ff,#8dd0ff);color:#03111f;font-weight:bold;
  padding:8px 14px;border-radius:10px;margin-bottom:16px;text-align:center}

.card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:14px;padding:16px}
.grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
@media (max-width:850px){.grid{grid-template-columns:1fr}}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
label{font-size:14px;color:var(--muted)}
.chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#0f1218}
.tables{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;margin-top:6px}
@media (max-width:520px){.tables{grid-template-columns:repeat(3,minmax(0,1fr))}}
input[type="number"]{background:#0f1218;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);width:90px}
input[type="checkbox"],input[type="radio"]{transform:scale(1.1)}
button{
  appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;
  background:linear-gradient(135deg,#4aa7ff,#8dd0ff);color:#03111f
}
button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
button.ghost{background:transparent;color:var(--muted)}
button:disabled{opacity:.6;cursor:not-allowed}
.question{font-size:clamp(28px,6vw,56px);font-weight:800;text-align:center;margin:10px 0 6px}
.question .op{color:var(--accent)}
.input-line{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
.input-line input{font-size:22px;text-align:center;width:180px}
.status{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;border-top:1px dashed var(--border);padding-top:10px;margin-top:10px;color:var(--muted)}
.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1218}
.pill.ok{border-color:rgba(52,211,153,.4);color:#d1fae5}
.pill.bad{border-color:rgba(248,113,113,.4);color:#fee2e2}
.feedback{min-height:26px;text-align:center;font-weight:800;margin-top:6px}
.feedback.ok{color:var(--ok)} .feedback.bad{color:var(--bad)}
.result{display:none} .result.active{display:block}
.muted{color:var(--muted)}

/* ===== Intro plein-√©cran ===== */
#intro{
  position:fixed; inset:0; z-index:9999;
  background:radial-gradient(1200px 800px at 30% -10%, #1b2330 0%, #0c0e12 60%);
  display:grid; place-items:center; opacity:1; transition:opacity .6s ease; pointer-events:auto;
}
#intro.hide{ opacity:0; pointer-events:none; }
.intro-center{ text-align:center; padding:24px; }
.intro-logo{
  font-weight:900; letter-spacing:2px; font-size:clamp(36px, 12vw, 96px);
  background:linear-gradient(135deg,#8dd0ff,#9b72ff);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  filter: drop-shadow(0 10px 30px rgba(0,0,0,.5));
  animation: popIn .9s cubic-bezier(.2,.9,.2,1) both;
}
.intro-sub{ color:#c9d6e2; margin:6px 0 16px; font-size:clamp(14px,3.5vw,18px); opacity:.9 }
.intro-btn{
  appearance:none; border:none; border-radius:14px; padding:12px 18px; font-weight:800; cursor:pointer;
  background:linear-gradient(135deg,#4aa7ff,#8dd0ff); color:#03111f; margin-top:20px;
}
.intro-skip{ background:transparent; border:1px solid rgba(255,255,255,.15); color:#d3dbe5; border-radius:14px; padding:10px 14px; }
@keyframes popIn{ from{ transform:scale(.8); opacity:0 } to{ transform:scale(1); opacity:1 } }
.stars,.stars2{ position:absolute; inset:-200% -200%; background-repeat:repeat; animation: drift 60s linear infinite; opacity:.6 }
.stars{ background-image: radial-gradient(2px 2px at 20px 30px,#fff,transparent), radial-gradient(1px 1px at 50px 80px,#fff,transparent), radial-gradient(1.5px 1.5px at 90px 40px,#fff,transparent), radial-gradient(1px 1px at 130px 120px,#fff,transparent); background-size: 200px 200px; }
.stars2{ background-image: radial-gradient(1.5px 1.5px at 60px 10px,#fff,transparent), radial-gradient(1px 1px at 120px 70px,#fff,transparent), radial-gradient(1.5px 1.5px at 170px 150px,#fff,transparent); background-size: 250px 250px; animation-duration: 90s; opacity:.35 }
@keyframes drift{ from{ transform:translate3d(0,0,0) } to{ transform:translate3d(-200px,-200px,0) } }
@media (prefers-reduced-motion: reduce){
  .stars,.stars2{ animation:none }
  .intro-logo{ animation:none }
}
  </style>
</head>
<body>
  <!-- INTRO OVERLAY -->
  <div id="intro" aria-hidden="true">
    <div class="stars"></div>
    <div class="stars2"></div>
    <div class="intro-center">
      <div class="intro-logo">974DR</div>
      <div class="intro-sub">Vive la 974DR ¬∑ Vive S√©cheron ‚ú®</div>
      <div class="intro-heart">‚ù§Ô∏è Vive les maths ‚ù§Ô∏è</div>

      <!-- ‚úÖ Bouton Play ‚Äî SANS onclick -->
      <button id="playIntroBtn" class="intro-btn" type="button">‚ñ∂Ô∏è Commencer</button>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="logo"><span>√ó</span></div>
      <div>
        <h1>Pour les √©leves de la 974DR !</h1>
        <div class="sub">Tables de multiplication ‚Äî entra√Ænement ludique (PWA, hors-ligne)</div>
      </div>
    </header>

    <div class="banner">
      üíô Vive la 974DR ! üíô <br>
      üíö Vive S√©cheron ! üíö <br>
      ‚ù§Ô∏è Vive les maths ‚ù§Ô∏è
    </div>

    <div style="text-align:center; margin:20px 0;">
  <button id="testBtn" class="intro-btn" type="button">
    üéµ Table de multiplication
  </button>
</div>
    
    <!-- Son d'intro -->
    <audio id="introAudio" src="mixkit-angelic-swell-presentation-2672.wav" preload="auto" playsinline></audio>

    <section class="card">
      <!-- ‚Ä¶ le reste de la page (r√©glages/jeu/r√©sultats) ‚Ä¶ -->
    </section>
  </div>

  <!-- ===== JS principal (jeu) ===== -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw-v9.js?v=3').catch(()=>{});
    }
  </script>

  <!-- Confetti + Fireworks -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="fireworks.js"></script>

  <!-- ‚úÖ Intro avec Play (robuste) -->
  <script>
  (function () {
    const SEEN_KEY = 'cm_intro_seen_v1';

    // 1) Toujours exposer la fonction globale
    window.startIntro = function startIntro() {
      const intro = document.getElementById('intro');
      const audio = document.getElementById('introAudio');
      try {
        audio.currentTime = 0;
        audio.play().catch(()=>{});   // iOS: si mode silencieux, le son peut rester muet ‚Äî mais le bouton ferme l'intro
      } catch(e) {}

      if (intro) intro.classList.add('hide');
      localStorage.setItem(SEEN_KEY, '1');

      const start = document.getElementById('startBtn');
      if (start) setTimeout(()=>start.focus({preventScroll:true}), 200);
    };

    // 2) Brancher le bouton d√®s qu'il existe (sans attendre DOMContentLoaded)
    (function bindNowOrLater(){
      const btn = document.getElementById('playIntroBtn');
      if (btn && !btn.__boundIntro) {
        btn.addEventListener('click', window.startIntro, { once: true });
        btn.__boundIntro = true;
      } else {
        // r√©essaye bri√®vement si le bouton n'est pas encore dans le DOM
        setTimeout(bindNowOrLater, 30);
      }
    })();

    // 3) Masquer l'intro si d√©j√† vue (mais APR√àS avoir d√©fini startIntro)
    if (localStorage.getItem(SEEN_KEY)) {
      const intro = document.getElementById('intro');
      if (intro) intro.classList.add('hide');
    }
  })();
  </script>

  <!-- Son de feu d'artifice -->
  <audio id="fw-sound" src="fireworks.mp3" preload="auto"></audio>
  <script>
  (function(){
    const SRC = document.getElementById('fw-sound').getAttribute('src');
    const POOL_SIZE = 6;
    const pool = [];
    for (let i = 0; i < POOL_SIZE; i++) {
      const a = new Audio(SRC);
      a.preload = 'auto';
      a.volume = 0.6;
      pool.push(a);
    }
    let idx = 0;

    function playFireworkOnce() {
      const a = pool[idx];
      idx = (idx + 1) % POOL_SIZE;
      try {
        a.currentTime = 0;
        a.play().catch(()=>{});
        setTimeout(()=>{ if (!a.paused) { a.pause(); a.currentTime = 0; } }, 700);
      } catch(e) {}
    }
    function stopAllFireworksSounds(){
      pool.forEach(a => { try { a.pause(); a.currentTime = 0; } catch(e) {} });
    }
    function introVisible(){
      const el = document.getElementById('intro');
      return el && !el.classList.contains('hide');
    }
    const unlockOnce = () => {
      if (introVisible()) return;          // ‚õî ignore les clics sur l‚Äôintro ‚Üí pas de ‚Äúpop‚Äù
      pool.forEach(a => a.play().then(()=>a.pause()).catch(()=>{}));
      document.removeEventListener('click', unlockOnce);
      document.removeEventListener('touchstart', unlockOnce);
      document.removeEventListener('keydown', unlockOnce);
    };
    document.addEventListener('click', unlockOnce);
    document.addEventListener('touchstart', unlockOnce);
    document.addEventListener('keydown', unlockOnce);

    window.__playFireworkSound = playFireworkOnce;
    window.__stopFireworksSound = stopAllFireworksSounds;
  })();
  </script>
</body>
</html>
