<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>974DR ‚Äî Calcul mental</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0e0f12" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#0e0f12; --card:#171a21; --text:#e8ecf1; --muted:#aab3bd;
      --accent:#ffd166; --ok:#34d399; --bad:#f87171; --border:rgba(255,255,255,.1);
    }
    html,body{height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:28px auto 64px;padding:0 16px}

    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .sub{color:var(--muted);font-size:14px}
    .icon-btn{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;
      border:1px solid var(--border);background:#0f1218;font-size:22px;line-height:1}
    .hidden{display:none!important}

    .card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:14px;padding:16px}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
    @media (max-width:850px){.grid{grid-template-columns:1fr}}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#0f1218}
    .toggle{display:inline-flex;align-items:center;gap:18px;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#0f1218;flex-wrap:wrap}
    input[type="number"]{background:#0f1218;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:#e8ecf1;width:90px}
    .mini input[type="number"]{width:70px}
    button{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;
      background:linear-gradient(135deg,#4aa7ff,#8dd0ff);color:#03111f}
    button.secondary{background:transparent;color:#e8ecf1;border:1px solid var(--border)}
    .question{font-size:clamp(28px,6vw,56px);font-weight:800;text-align:center;margin:10px 0 6px}
    .question .op{color:var(--accent)}
    .input-line{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
    .input-line input{font-size:22px;text-align:center;width:180px}
    .status{display:flex;gap:10px;justify-content:space-between;border-top:1px dashed var(--border);padding-top:10px;margin-top:10px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1218}
    .pill.ok{border-color:rgba(52,211,153,.4);color:#d1fae5}
    .pill.bad{border-color:rgba(248,113,113,.4);color:#fee2e2}
    .feedback{min-height:26px;text-align:center;font-weight:800;margin-top:6px}
    .feedback.ok{color:var(--ok)} .feedback.bad{color:var(--bad)}
    .result{display:none} .result.active{display:block}

    /* Intro (overlay) */
    #intro{position:fixed;inset:0;z-index:9000;background:radial-gradient(1200px 800px at 30% -10%, #1b2330 0%, #0c0e12 60%);
      display:grid;place-items:center;opacity:1;transition:opacity .6s ease}
    #intro.hide{opacity:0;pointer-events:none}
    .intro-center{text-align:center;padding:24px}
    .intro-logo{font-weight:900;letter-spacing:2px;font-size:clamp(36px,12vw,96px);
      background:linear-gradient(135deg,#8dd0ff,#9b72ff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .intro-sub{color:#c9d6e2;margin:6px 0 16px;font-size:clamp(14px,3.5vw,18px);opacity:.9}
    .intro-heart{font-size:22px;color:#ff4d4d;font-weight:800;margin-bottom:14px}
    .intro-btn{border:none;border-radius:14px;padding:12px 18px;font-weight:800;cursor:pointer;
      background:linear-gradient(135deg,#4aa7ff,#8dd0ff);color:#03111f;margin-top:12px}

    /* grille des tables */
    .tables{display:grid;grid-template-columns:repeat(4,minmax(90px,1fr));gap:10px}
    @media (max-width:520px){.tables{grid-template-columns:repeat(3,minmax(90px,1fr))}}
    .table-chip{display:flex;align-items:center;gap:8px;justify-content:center;border:1px solid var(--border);background:#0f1218;border-radius:12px;padding:10px;font-weight:700}

    /* Overlay vid√©os */
    #videosOverlay{position:fixed;inset:0;z-index:9500;display:none}
    #videosBackdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
    #videosModal{position:relative;max-width:980px;margin:40px auto;padding:16px;border:1px solid var(--border);border-radius:14px;background:rgba(20,24,31,.95)}
    .video-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .video-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:10px}
    .video-card{background:#0f1218;border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer}
    .video-card img{width:100%;display:block}
    .video-card .vc-title{padding:8px 10px;font-size:14px;color:var(--muted)}
    .player-wrap{position:relative;padding-top:56.25%;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-top:14px}
    .player-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .add-video{display:flex;gap:8px;margin-top:10px}
    .add-video input{flex:1;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0f1218;color:var(--text)}
 /* ===== Overlay vid√©os ===== */
#videosOverlay{position:fixed;inset:0;z-index:9998;display:none;}
#videosOverlay.active{display:block;}
#videosOverlay .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);}
#videosOverlay .sheet{
  position:relative;max-width:920px;margin:6vh auto;background:#0f1218;
  border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:14px;
}
#videosOverlay header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
#videosOverlay h3{margin:0;font-size:18px;color:#e8ecf1}
#videosOverlay .close{border:1px solid rgba(255,255,255,.15);background:#141820;
  color:#e8ecf1;border-radius:12px;padding:8px 10px;cursor:pointer}
.vgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:800px){.vgrid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:520px){.vgrid{grid-template-columns:1fr}}
.vcard{background:#12161f;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
.vcard iframe{display:block;width:100%;aspect-ratio:16/9;border:0}
.vcard .title{padding:10px;color:#cfd6df;font-size:14px}
.no-scroll{overflow:hidden;height:100%}
  </style>
</head>
<body>

  <!-- Intro -->
  <div id="intro" aria-hidden="true">
    <div class="intro-center">
      <div class="intro-logo">974DR</div>
      <div class="intro-sub">‚ú® Vive S√©cheron ‚ú®</div>
      <div class="intro-heart">‚ù§Ô∏è Vive les maths ‚ù§Ô∏è</div>
      <button id="introMultBtn" class="intro-btn" type="button">Table de multiplication</button><br>
      <button id="introDivBtn" class="intro-btn" type="button">Table de division</button><br>
      <button id="introVidBtn" class="intro-btn" type="button">Vid√©os de th√©orie</button>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div style="flex:1">
        <div class="sub">Tables de calcul ‚Äî entra√Ænement ludique</div>
      </div>
      <button id="homeBtn" class="icon-btn hidden" title="Retour menu" aria-label="Retour menu">üè†</button>
    </header>

    <section class="card">
      <div class="grid">
        <div>
          <!-- Modes -->
          <div class="toggle">
            <label><input type="radio" name="runmode" value="train" checked> Entra√Ænement</label>
            <label><input type="radio" name="runmode" value="sprint"> Sprint 60 s</label>
          </div>

          <!-- Nb questions (train seulement) -->
          <div class="chip">
            <label>Nb questions
              <input id="numQ" type="number" value="20" min="1" max="200" style="margin-left:8px">
            </label>
          </div>

          <!-- Choix des tables (multiplication) -->
          <div class="chip" id="blockTablesTitle"><strong>Toutes (2‚Äì11)</strong>
            <input id="allTables" type="checkbox" style="margin-left:8px" checked>
          </div>
          <div id="tablesBlock" class="tables" aria-label="S√©lection des tables"></div>

          <!-- Plage du second facteur -->
          <div class="chip mini" id="rangeBlock" style="margin-top:8px;gap:10px;flex-wrap:wrap">
            <span>Deuxi√®me facteur de</span>
            <input id="bMin" type="number" value="0" min="0" max="11">
            <span>√†</span>
            <input id="bMax" type="number" value="11" min="0" max="11">
          </div>

          <button id="startBtn" style="margin-top:10px">D√©marrer</button>
        </div>

        <div>
          <div id="play" class="card" style="display:none">
            <div class="question"><span id="qa"></span> <span id="op" class="op"></span> <span id="qb"></span> = ?</div>
            <div class="input-line">
              <input id="answer" type="number" inputmode="numeric">
              <button id="okBtn">Valider</button>
              <button id="backBtn" class="secondary" type="button">Retour menu</button>
            </div>
            <div id="feedback" class="feedback"></div>
            <div class="status">
              <div class="pill">Q <span id="count">0</span></div>
              <div class="pill ok">‚úîÔ∏é <span id="good">0</span></div>
              <div class="pill bad">‚úñÔ∏é <span id="bad">0</span></div>
              <div class="pill" id="timePill" style="display:none">‚è±Ô∏è <span id="timeLeft">60</span>s</div>
            </div>
          </div>

          <div id="result" class="result card">
            <h3>R√©sum√©</h3>
            <p>Score : <strong><span id="scorePct">0</span>%</strong></p>
            <div class="input-line">
              <button id="againBtn">Refaire</button>
              <button id="backFromResult" class="secondary" type="button">Retour menu</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Overlay Vid√©os -->
  <div id="videosOverlay">
    <div id="videosBackdrop"></div>
    <div id="videosModal">
      <div class="video-header">
        <div style="font-weight:800">Vid√©os de th√©orie</div>
        <div style="display:flex;gap:8px">
          <button id="closeVideosBtn" class="secondary">‚úñÔ∏è Fermer</button>
          <button id="backToMenuFromVideos">Retour menu</button>
        </div>
      </div>
      <div class="add-video">
        <input id="videoInput" type="url" placeholder="Coller un lien YouTube (shorts ou vid√©o)...">
        <button id="addVideoBtn">Ajouter</button>
      </div>
      <div class="video-grid" id="videoGrid"></div>
      <div class="player-wrap" id="playerWrap" style="display:none">
        <iframe id="ytPlayer" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- Audio feux d'artifice -->
  <audio id="fwSound" preload="auto">
    <source src="fireworks.mp3" type="audio/mpeg">
  </audio>

  <!-- D√©verrouillage audio iOS + pont pour fireworks.js -->
  <script>
    (function () {
      const a = document.getElementById('fwSound');
      let unlocked = false;
      function unlockOnce() {
        if (unlocked) return;
        const p = a.play();
        if (p && p.then) {
          p.then(() => { a.pause(); a.currentTime = 0; unlocked = true; })
           .catch(()=>{});
        } else { a.pause(); a.currentTime=0; unlocked=true; }
      }
      ['introMultBtn','introDivBtn','introVidBtn','startBtn','okBtn','againBtn','backBtn','backFromResult']
        .forEach(id=>{
          const el=document.getElementById(id);
          if(el) el.addEventListener('click', unlockOnce, {once:true});
        });

      window.__startFireworksSound = () => {
        if (!unlocked) return;
        try { a.loop = true; a.currentTime = 0; a.play(); } catch {}
      };
      window.__stopFireworksSound = () => {
        try { a.loop = false; a.pause(); a.currentTime = 0; } catch {}
      };
    })();
  </script>

  <!-- Feux d'artifice -->
  <script src="fireworks.js"></script>

  <!-- LOGIQUE DU SITE -->
  <script>
    // ---------- √âTAT ----------
    let qa=0,qb=0,qCount=0,good=0,bad=0,numQ=20;
    let currentMode="mult"; // 'mult' | 'div'
    let runMode="train";    // 'train' | 'sprint'
    let timer=null, endAt=0;

    // tables s√©lectionn√©es (2..11)
    let tablesSel = new Set([2,3,4,5,6,7,8,9,10,11]);
    let bMin=0, bMax=11;

    // ---------- DOM ----------
    const qaEl=document.getElementById('qa'),
          qbEl=document.getElementById('qb'),
          opEl=document.getElementById('op'),
          countEl=document.getElementById('count'),
          goodEl=document.getElementById('good'),
          badEl=document.getElementById('bad'),
          feedback=document.getElementById('feedback'),
          homeBtn=document.getElementById('homeBtn'),
          timePill=document.getElementById('timePill'),
          timeLeftEl=document.getElementById('timeLeft');

    // G√©n√®re les chips x2..x11
    const tablesBlock = document.getElementById('tablesBlock');
    for(let t=2;t<=11;t++){
      const id = 't'+t;
      const div = document.createElement('label');
      div.className='table-chip';
      div.innerHTML = `<input id="${id}" type="checkbox" checked> √ó${t}`;
      tablesBlock.appendChild(div);
      div.querySelector('input').addEventListener('change', e=>{
        if(e.target.checked) tablesSel.add(t); else tablesSel.delete(t);
        syncAllTables();
        savePrefs();
      });
    }

    // ---------- PREFS ----------
    function syncFromPrefs(){
      const prefs = JSON.parse(localStorage.getItem('cm_prefs')||'{}');
      if(prefs.numQ) numQ=prefs.numQ;
      if(prefs.bMin!=null) bMin=prefs.bMin;
      if(prefs.bMax!=null) bMax=prefs.bMax;
      if(Array.isArray(prefs.tables)) tablesSel = new Set(prefs.tables);
      if(prefs.runMode) runMode = prefs.runMode;

      document.getElementById('numQ').value = numQ;
      document.getElementById('bMin').value = bMin;
      document.getElementById('bMax').value = bMax;
      const rm=document.querySelector(`input[name="runmode"][value="${runMode}"]`);
      if(rm) rm.checked = true;

      for(let t=2;t<=11;t++){
        document.getElementById('t'+t).checked = tablesSel.has(t);
      }
      syncAllTables();
      toggleTrainInputs();
    }
    function savePrefs(){
      localStorage.setItem('cm_prefs', JSON.stringify({
        numQ, bMin, bMax, tables:[...tablesSel], runMode
      }));
    }
    function syncAllTables(){
      const allOn = (tablesSel.size===10);
      document.getElementById('allTables').checked = allOn;
    }
    document.getElementById('allTables').addEventListener('change', e=>{
      if(e.target.checked){ tablesSel = new Set([2,3,4,5,6,7,8,9,10,11]); }
      else { tablesSel.clear(); }
      for(let t=2;t<=11;t++) document.getElementById('t'+t).checked = tablesSel.has(t);
      savePrefs();
    });

    // ---------- LOGIQUE ----------
    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function newQ(){
      if(currentMode==="mult"){
        const list = [...tablesSel];
        const qA = list.length? list[randInt(0,list.length-1)] : randInt(2,11);
        let min=bMin, max=bMax;
        if(min>max){ const tmp=min; min=max; max=tmp; }
        const qB = randInt(Math.max(0,min), Math.min(11,max));
        qa=qA; qb=qB; opEl.textContent="√ó";
      } else {
        qb = randInt(2,11);
        qa = qb * randInt(2,11);
        opEl.textContent="√∑";
      }
      qaEl.textContent=qa; qbEl.textContent=qb;
      const a=document.getElementById('answer'); a.value=''; a.focus();
    }

    function check(){
      const ans=parseInt(document.getElementById('answer').value);
      const correct=(currentMode==="mult")?(qa*qb):(qa/qb);
      if(ans===correct){ good++; feedback.textContent='‚úîÔ∏è'; feedback.className='feedback ok'; }
      else { bad++; feedback.textContent=`‚úñÔ∏è (${correct})`; feedback.className='feedback bad'; }
      qCount++; updateUI();

      if(runMode==='train'){
        if(qCount<numQ) newQ(); else end();
      }else{ // sprint
        if(Date.now()<endAt) newQ(); else end();
      }
    }

    function updateUI(){
      countEl.textContent=qCount; goodEl.textContent=good; badEl.textContent=bad;
    }

    function toggleTrainInputs(){
      const nQ = document.getElementById('numQ');
      nQ.disabled = (runMode==='sprint');
      timePill.style.display = (runMode==='sprint') ? '' : 'none';
    }

    function start(){
      runMode = document.querySelector('input[name="runmode"]:checked').value;
      numQ = parseInt(document.getElementById('numQ').value)||20;
      bMin = parseInt(document.getElementById('bMin').value)||0;
      bMax = parseInt(document.getElementById('bMax').value)||11;
      savePrefs();
      toggleTrainInputs();

      qCount=0; good=0; bad=0; updateUI();
      feedback.textContent=''; feedback.className='feedback';
      document.getElementById('play').style.display='block';
      document.getElementById('result').style.display='none';

      if(runMode==='sprint'){
        endAt = Date.now()+60000;
        timeLeftEl.textContent = 60;
        clearInterval(timer);
        timer = setInterval(()=>{
          const left = Math.max(0, Math.ceil((endAt - Date.now())/1000));
          timeLeftEl.textContent = left;
          if(left<=0){ clearInterval(timer); }
        }, 200);
      }else{
        clearInterval(timer);
      }

      newQ();
    }

    function end(){
      clearInterval(timer);
      document.getElementById('play').style.display='none';
      document.getElementById('result').style.display='block';
      const total = Math.max(1,qCount);
      document.getElementById('scorePct').textContent = Math.round(100*good/total);

      // feux + son si 100%
      if(good===total && total>0){
        if(window.showFireworks) window.showFireworks(7000);
      }
    }

    function backToMenu(){
      clearInterval(timer);
      document.getElementById('play').style.display='none';
      document.getElementById('result').style.display='none';
      feedback.textContent=''; feedback.className='feedback';
      document.getElementById('intro').classList.remove('hide');
      homeBtn.classList.add('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Boutons du jeu
    document.getElementById('startBtn').onclick=start;
    document.getElementById('okBtn').onclick=check;
    document.getElementById('againBtn').onclick=start;
    document.getElementById('backBtn').onclick=backToMenu;
    document.getElementById('backFromResult').onclick=backToMenu;
    homeBtn.onclick=backToMenu;
    document.querySelectorAll('input[name="runmode"]').forEach(r=>r.addEventListener('change',()=>{
      runMode=r.value; toggleTrainInputs(); savePrefs();
    }));

    // Intro : choix du mode + bouton vid√©os
    (function () {
      const intro   = document.getElementById('intro');
      const multBtn = document.getElementById('introMultBtn');
      const divBtn  = document.getElementById('introDivBtn');
      function closeIntro(){
        intro.classList.add('hide');
        homeBtn.classList.remove('hidden');
      }
      multBtn.addEventListener('click', ()=>{ currentMode="mult"; closeIntro(); });
      divBtn .addEventListener('click', ()=>{ currentMode="div";  closeIntro(); });
    })();

    // Charger pr√©f√©rences au d√©marrage
    syncFromPrefs();
  </script>

  <!-- Gestion Overlay Vid√©os -->
  <script>
    // Stockage vid√©os
    const DEFAULT_VIDEOS = [
      'https://m.youtube.com/shorts/AEyAdwoXRlk',
      'https://m.youtube.com/shorts/AsGTASDGnTY',
      'https://m.youtube.com/shorts/CFtFN_IO8xU',
      'https://m.youtube.com/watch?v=xfYx8qWnxg0'
    ];
    function loadVideos(){
      return JSON.parse(localStorage.getItem("cm_videos")||"null") || DEFAULT_VIDEOS;
    }
    function saveVideos(arr){
      localStorage.setItem("cm_videos", JSON.stringify(arr));
    }
    function ytId(url){
      try{
        const u=new URL(url);
        if(u.hostname.includes("youtu.be")) return u.pathname.slice(1);
        if(u.pathname.startsWith("/shorts/")) return u.pathname.split("/")[2];
        if(u.searchParams.get("v")) return u.searchParams.get("v");
      }catch{}
      return "";
    }
    const ytThumb=(id)=>`https://img.youtube.com/vi/${id}/hqdefault.jpg`;
    const ytEmbed=(id)=>`https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;

    const videosOverlay=document.getElementById("videosOverlay"),
          videoGrid=document.getElementById("videoGrid"),
          ytPlayer=document.getElementById("ytPlayer"),
          playerWrap=document.getElementById("playerWrap");

    let videoList = loadVideos();

    function renderVideos(){
      videoGrid.innerHTML="";
      videoList.forEach((url,idx)=>{
        const id=ytId(url); if(!id) return;
        const card=document.createElement("button");
        card.className="video-card"; card.type="button";
        card.innerHTML=`<img src="${ytThumb(id)}" alt=""><div class="vc-title">Vid√©o ${idx+1}</div>`;
        card.onclick=()=>{ ytPlayer.src=ytEmbed(id); playerWrap.style.display=""; };
        videoGrid.appendChild(card);
      });
    }
    function openVideos(){videosOverlay.style.display="";document.body.style.overflow="hidden";renderVideos();}
    function closeVideos(){ytPlayer.src="about:blank";playerWrap.style.display="none";videosOverlay.style.display="none";document.body.style.overflow="";}

    document.getElementById("introVidBtn").onclick=()=>{openVideos();document.getElementById("intro").classList.add("hide");};
    document.getElementById("closeVideosBtn").onclick=closeVideos;
    document.getElementById("backToMenuFromVideos").onclick=()=>{closeVideos();document.getElementById("intro").classList.remove("hide");};
    document.getElementById("videosBackdrop").onclick=closeVideos;

    document.getElementById("addVideoBtn").onclick=()=>{
      const url=document.getElementById("videoInput").value.trim();
      if(!url) return;
      const id=ytId(url);
      if(!id){alert("URL YouTube invalide");return;}
      videoList.push(url);
      saveVideos(videoList);
      renderVideos();
      document.getElementById("videoInput").value="";
    };
  </script>
<script>
/* ---------- Vid√©os : liste + overlay ---------- */
// Mets ici tes liens & titres
const VIDEOS = [
  { url:'https://m.youtube.com/shorts/AEyAdwoXRlk', title:'Astuce 1 (shorts)' },
  { url:'https://m.youtube.com/shorts/AsGTASDGnTY', title:'Astuce 2 (shorts)' },
  { url:'https://m.youtube.com/shorts/CFtFN_IO8xU', title:'Astuce 3 (shorts)' },
  { url:'https://m.youtube.com/watch?v=xfYx8qWnxg0', title:'24 op√©rations avec d√©cimaux' }
];

// Convertit n‚Äôimporte quel lien YouTube en URL <iframe> /embed/ID
function toEmbed(url){
  try{
    const u = new URL(url);
    const host = u.hostname.replace('www.','').replace('m.','');
    let id='';
    if (host==='youtube.com' || host==='youtu.be'){
      if (u.pathname.startsWith('/shorts/')) { id = u.pathname.split('/')[2]; }
      else if (u.hostname==='youtu.be') { id = u.pathname.slice(1); }
      else if (u.searchParams.get('v')) { id = u.searchParams.get('v'); }
      else if (u.pathname.startsWith('/embed/')) { id = u.pathname.split('/')[2]; }
    }
    if (!id) return null;
    return `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&autoplay=0`;
  }catch{ return null; }
}

(function(){
  const overlay = document.getElementById('videosOverlay');
  const grid = document.getElementById('videosGrid');
  const closeBtn = document.getElementById('closeVideosBtn');
  const introVideosBtn = document.getElementById('introVideosBtn'); // le bouton du menu

  // Construit la grille
  grid.innerHTML = '';
  VIDEOS.forEach(v=>{
    const src = toEmbed(v.url);
    if (!src) return;
    const card = document.createElement('div');
    card.className = 'vcard';
    card.innerHTML = `
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen src="${src}"></iframe>
      <div class="title">${v.title||''}</div>`;
    grid.appendChild(card);
  });

  function openVideos(){
    overlay.classList.add('active');
    document.documentElement.classList.add('no-scroll');
    document.body.classList.add('no-scroll');
  }
  function closeVideos(){
    // stoppe toutes les vid√©os en retirant/repla√ßant src
    overlay.querySelectorAll('iframe').forEach(f=>{
      const s = f.src; f.src = ''; f.src = s.replace('autoplay=1','autoplay=0');
    });
    overlay.classList.remove('active');
    document.documentElement.classList.remove('no-scroll');
    document.body.classList.remove('no-scroll');
  }

  if (introVideosBtn) introVideosBtn.addEventListener('click', openVideos);
  closeBtn.addEventListener('click', closeVideos);
  overlay.querySelector('.backdrop').addEventListener('click', closeVideos);

  // Optionnel : ESC pour fermer
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay.classList.contains('active')) closeVideos(); });
})();
</script>
  <!-- Service worker -->
  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js?v=24').then(r=>r.update()).catch(()=>{});
    }
  </script>
  <!-- ===== OVERLAY VID√âOS ===== -->
<div id="videosOverlay" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="sheet">
    <header>
      <h3>Vid√©os de th√©orie</h3>
      <button class="close" id="closeVideosBtn" type="button" aria-label="Fermer">Fermer ‚úï</button>
    </header>
    <div class="vgrid" id="videosGrid"><!-- inject√© par JS --></div>
  </div>
</div>
</body>
</html>
