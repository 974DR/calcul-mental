<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> 974DR ‚Äî Calcul mental</title>

  <!-- Ic√¥ne & PWA -->
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0e0f12">

  <style>
    :root{
      --bg:#0e0f12; --card:#171a21; --text:#e8ecf1; --muted:#aab3bd;
      --accent:#ffd166; --ok:#34d399; --bad:#f87171; --border:rgba(255,255,255,.1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
 
    .wrap{max-width:980px;margin:28px auto 64px;padding:0 16px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    header .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#4aa7ff,#9b72ff);display:grid;place-items:center}
    header .logo span{font-weight:800;color:white;font-size:20px}
    h1{margin:0;font-size:clamp(22px,4vw,34px)}
    .sub{color:var(--muted);font-size:14px}

    .banner{background:linear-gradient(135deg,#4aa7ff,#8dd0ff);color:#03111f;font-weight:bold;
      padding:8px 14px;border-radius:10px;margin-bottom:16px;text-align:center}

    .card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:14px;padding:16px}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
    @media (max-width:850px){.grid{grid-template-columns:1fr}}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    label{font-size:14px;color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#0f1218}
    .tables{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;margin-top:6px}
    @media (max-width:520px){.tables{grid-template-columns:repeat(3,minmax(0,1fr))}}
    input[type="number"]{background:#0f1218;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);width:90px}
    input[type="checkbox"],input[type="radio"]{transform:scale(1.1)}
    button{
      appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;
      background:linear-gradient(135deg,#4aa7ff,#8dd0ff);color:#03111f
    }
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    button.ghost{background:transparent;color:var(--muted)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .question{font-size:clamp(28px,6vw,56px);font-weight:800;text-align:center;margin:10px 0 6px}
    .question .op{color:var(--accent)}
    .input-line{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
    .input-line input{font-size:22px;text-align:center;width:180px}
    .status{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;border-top:1px dashed var(--border);padding-top:10px;margin-top:10px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1218}
    .pill.ok{border-color:rgba(52,211,153,.4);color:#d1fae5}
    .pill.bad{border-color:rgba(248,113,113,.4);color:#fee2e2}
    .feedback{min-height:26px;text-align:center;font-weight:800;margin-top:6px}
    .feedback.ok{color:var(--ok)} .feedback.bad{color:var(--bad)}
    .result{display:none} .result.active{display:block}
    .muted{color:var(--muted)}
    /* ===== Intro plein-√©cran =================================================== */
#intro{
  position:fixed; inset:0; z-index:9999; background:radial-gradient(1200px 800px at 30% -10%, #1b2330 0%, #0c0e12 60%);
  display:grid; place-items:center; opacity:1; transition:opacity .6s ease; pointer-events:auto;
}
#intro.hide{ opacity:0; pointer-events:none; }

.intro-center{ text-align:center; padding:24px; }
.intro-logo{
  font-weight:900; letter-spacing:2px; font-size:clamp(36px, 12vw, 96px);
  background:linear-gradient(135deg,#8dd0ff,#9b72ff);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  filter: drop-shadow(0 10px 30px rgba(0,0,0,.5));
  animation: popIn .9s cubic-bezier(.2,.9,.2,1) both;
}
.intro-sub{ color:#c9d6e2; margin:6px 0 16px; font-size:clamp(14px,3.5vw,18px); opacity:.9 }
.intro-btn{
  appearance:none; border:none; border-radius:14px; padding:12px 18px; font-weight:800; cursor:pointer;
  background:linear-gradient(135deg,#4aa7ff,#8dd0ff); color:#03111f; margin-right:8px;
}
.intro-skip{ background:transparent; border:1px solid rgba(255,255,255,.15); color:#d3dbe5; border-radius:14px; padding:10px 14px; }

@keyframes popIn{ from{ transform:scale(.8); opacity:0 } to{ transform:scale(1); opacity:1 } }

/* √©toiles */
.stars,.stars2{ position:absolute; inset:-200% -200%; background-repeat:repeat; animation: drift 60s linear infinite; opacity:.6 }
.stars{ background-image: radial-gradient(2px 2px at 20px 30px,#fff,transparent), radial-gradient(1px 1px at 50px 80px,#fff,transparent), radial-gradient(1.5px 1.5px at 90px 40px,#fff,transparent), radial-gradient(1px 1px at 130px 120px,#fff,transparent); background-size: 200px 200px; }
.stars2{ background-image: radial-gradient(1.5px 1.5px at 60px 10px,#fff,transparent), radial-gradient(1px 1px at 120px 70px,#fff,transparent), radial-gradient(1.5px 1.5px at 170px 150px,#fff,transparent); background-size: 250px 250px; animation-duration: 90s; opacity:.35 }
@keyframes drift{ from{ transform:translate3d(0,0,0) } to{ transform:translate3d(-200px,-200px,0) } }

/* accessibilit√© */
@media (prefers-reduced-motion: reduce){
  .stars,.stars2{ animation:none }
  .intro-logo{ animation:none }
}
  </style>
</head>
<body>
 <!-- INTRO OVERLAY -->
<div id="intro" aria-hidden="true">
  <div class="stars"></div>
  <div class="stars2"></div>
  <div class="intro-center">
    <div class="intro-logo">974DR</div>
    <div class="intro-sub">Vive la 974DR ¬∑ Vive S√©cheron ‚ú®</div>
    <button id="introBtn" class="intro-btn">Entrer</button>
    <button id="skipIntro" class="intro-skip" aria-label="Passer l'introduction">Passer</button>
  </div>
</div>
  <div class="wrap">
    <header>
      <div class="logo"><span>√ó</span></div>
      <div>
        <h1>Pour les √©leves de la 974DR !</h1>
        <div class="sub">Tables de multiplication ‚Äî entra√Ænement ludique (PWA, hors-ligne)</div>
      </div>
    </header>

  <div class="banner">
  üíô Vive la 974DR ! üíô <br>
  üíö Vive S√©cheron ! üíö
</div>

    <section class="card">
      <div class="grid">
        <!-- R√©glages -->
        <div>
          <div class="row" style="margin-bottom:8px">
            <span class="chip"><input type="radio" name="mode" value="train" checked> Entra√Ænement</span>
            <span class="chip"><input type="radio" name="mode" value="sprint"> Sprint 60 s</span>
            <span class="chip"><label>Nb questions <input id="numQ" type="number" min="5" max="100" value="20"></label></span>
          </div>

          <div class="row">
            <span class="chip"><input type="checkbox" id="allTables"> <strong>Toutes (2‚Äì11)</strong></span>
          </div>
          <div id="tablesGrid" class="tables" style="margin-bottom:8px"></div>

          <div class="row">
            <span class="chip"><label>Deuxi√®me facteur de
              <input id="minB" type="number" min="0" max="11" value="0"> √†
              <input id="maxB" type="number" min="0" max="11" value="11"></label></span>
            <span class="chip"><input type="checkbox" id="instant" checked> Correction imm√©diate</span>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="startBtn">D√©marrer</button>
            <button class="secondary" id="resetBtn">R√©initialiser</button>
          </div>
        </div>

        <!-- Jeu -->
        <div>
          <div id="play" class="card" style="display:none">
            <div class="question"><span id="qa"></span> <span class="op">√ó</span> <span id="qb"></span> <span class="op">=</span> ?</div>
            <div class="input-line">
              <input id="answer" type="number" inputmode="numeric" placeholder="Ta r√©ponse">
              <button id="okBtn">Valider</button>
              <button class="secondary" id="skipBtn">Je ne sais pas</button>
            </div>
            <div id="feedback" class="feedback"></div>
            <div class="status">
              <div class="pill">Q <span id="count">0</span></div>
              <div class="pill ok">‚úîÔ∏é <span id="good">0</span></div>
              <div class="pill bad">‚úñÔ∏é <span id="bad">0</span></div>
              <div class="pill">‚è±Ô∏è <span id="timer">00:00</span></div>
              <div class="pill">üî• S√©rie : <span id="streak">0</span></div>
            </div>
          </div>

          <div id="result" class="result card">
            <h3>R√©sum√©</h3>
            <p>Score : <strong><span id="scorePct">0</span>%</strong> ‚Äî Temps : <strong id="totalTime">00:00</strong> ‚Äî Moyenne : <strong id="tPerQ">‚Äî</strong></p>
            <p class="muted" id="mistakesTitle" style="margin:6px 0 0">Erreurs √† revoir :</p>
            <ul id="mistakes" style="margin:6px 0 0; padding-left:18px"></ul>
            <p class="muted" style="margin-top:10px;text-align:center">üíô Vive la 974DR ! üíô</p>
            <div class="row"><button id="againBtn">Refaire une session</button></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // PWA : enregistrement du Service Worker
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }

    // --------- S√©lection √©l√©ments
    const tablesGrid = document.getElementById('tablesGrid');
    const allTables = document.getElementById('allTables');
    const minB = document.getElementById('minB');
    const maxB = document.getElementById('maxB');
    const numQ = document.getElementById('numQ');
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const instantCb = document.getElementById('instant');

    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const play = document.getElementById('play');
    const resultEl = document.getElementById('result');

    const qa = document.getElementById('qa');
    const qb = document.getElementById('qb');
    const answer = document.getElementById('answer');
    const okBtn = document.getElementById('okBtn');
    const skipBtn = document.getElementById('skipBtn');
    const feedback = document.getElementById('feedback');

    const countEl = document.getElementById('count');
    const goodEl = document.getElementById('good');
    const badEl = document.getElementById('bad');
    const timerEl = document.getElementById('timer');
    const streakEl = document.getElementById('streak');

    const scorePct = document.getElementById('scorePct');
    const totalTime = document.getElementById('totalTime');
    const tPerQ = document.getElementById('tPerQ');
    const mistakesUl = document.getElementById('mistakes');
    const againBtn = document.getElementById('againBtn');

    // --------- Construction des cases des tables (2..11)
    for(let t=2;t<=11;t++){
      const label = document.createElement('label');
      label.className = 'chip';
      label.innerHTML = '<input type="checkbox" class="table-check" value="'+t+'"> √ó'+t;
      tablesGrid.appendChild(label);
    }
    const tableChecks = () => Array.from(document.querySelectorAll('.table-check'));

    // --------- Sauvegarde/chargement des r√©glages
    function saveSettings(){
      const selected = tableChecks().filter(c=>c.checked).map(c=>+c.value);
      const s = {
        mode: Array.from(modeRadios).find(r=>r.checked)?.value || 'train',
        allTables: allTables.checked,
        selected, minB:+minB.value, maxB:+maxB.value, numQ:+numQ.value,
        instant: instantCb.checked
      };
      localStorage.setItem('cm_settings', JSON.stringify(s));
    }
    function loadSettings(){
      const raw = localStorage.getItem('cm_settings');
      if(!raw){
        allTables.checked = true; tableChecks().forEach(c=>c.checked=true);
        return;
      }
      try{
        const s = JSON.parse(raw);
        (document.querySelector('input[name="mode"][value="'+(s.mode||'train')+'"]')||{}).checked = true;
        allTables.checked = !!s.allTables;
        tableChecks().forEach(c=>c.checked = s.allTables || (s.selected||[]).includes(+c.value));
        minB.value = s.minB ?? 0; maxB.value = s.maxB ?? 11; numQ.value = s.numQ ?? 20;
        instantCb.checked = s.instant ?? true;
      }catch(e){ allTables.checked = true; tableChecks().forEach(c=>c.checked=true); }
    }
    loadSettings();

    // Sync All/Tables
    allTables.addEventListener('change', ()=>{ const on=allTables.checked; tableChecks().forEach(c=>c.checked=on); saveSettings(); });
    tablesGrid.addEventListener('change', ()=>{ allTables.checked = tableChecks().every(c=>c.checked); saveSettings(); });
    [minB,maxB,numQ].forEach(i=>i.addEventListener('change', saveSettings));
    modeRadios.forEach(r=>r.addEventListener('change', saveSettings));
    instantCb.addEventListener('change', saveSettings);

    // --------- Logique de session
    let session = null;
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function fmt(ms){ const s=Math.floor(ms/1000), m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0'); }

    function newSession(){
      const selectedTables = tableChecks().filter(c=>c.checked).map(c=>+c.value);
      if(selectedTables.length===0){ alert('S√©lectionnez au moins une table.'); return; }
      const bMin = Math.max(0, Math.min(11, +minB.value||0));
      const bMax = Math.max(bMin, Math.min(11, +maxB.value||11));
      const mode = Array.from(modeRadios).find(r=>r.checked)?.value || 'train';
      const total = mode==='train' ? Math.max(5, Math.min(100, +numQ.value||20)) : Infinity;

      session = {
        mode, selectedTables, bMin, bMax, total,
        n:0, good:0, bad:0, streak:0, start: performance.now(), elapsed:0, lastTick: performance.now(),
        finished:false, current:null, mistakes:{}, history:[]
      };

      // UI
      feedback.textContent = ''; feedback.className = 'feedback';
      goodEl.textContent = '0'; badEl.textContent = '0'; countEl.textContent = '0'; streakEl.textContent = '0'; timerEl.textContent='00:00';
      play.style.display='block'; resultEl.classList.remove('active');
      okBtn.disabled=false; skipBtn.disabled=false;

      nextQuestion(); answer.value=''; answer.focus({preventScroll:true});
      requestAnimationFrame(tick);
    }

    function nextQuestion(){
      if(!session || session.finished) return;
      if(session.mode==='train' && session.n>=session.total) return finish();
      if(session.mode==='sprint' && session.elapsed>=60000) return finish();

      session.n++; countEl.textContent = String(session.n);
      const a = session.selectedTables[randInt(0, session.selectedTables.length-1)];
      const b = randInt(session.bMin, session.bMax);
      session.current = {a,b,sol:a*b};

      qa.textContent = a; qb.textContent = b;
      answer.value=''; answer.focus({preventScroll:true});
    }

    function tick(){
      if(!session || session.finished) return;
      const now = performance.now();
      session.elapsed += now - session.lastTick;
      session.lastTick = now;
      timerEl.textContent = fmt(session.elapsed);
      if(session.mode==='sprint' && session.elapsed>=60000){ finish(); return; }
      requestAnimationFrame(tick);
    }

    function submit(skipped=false){
      if(!session || session.finished) return;
      const val = skipped ? null : Number(answer.value);
      const ok = !skipped && (val === session.current.sol);

      if(ok){
        session.good++; goodEl.textContent = String(session.good);
        session.streak++; streakEl.textContent = String(session.streak);
        feedback.textContent = '‚úÖ Bravo !'; feedback.className = 'feedback ok';
      }else{
        session.bad++; badEl.textContent = String(session.bad);
        session.streak = 0; streakEl.textContent = '0';
        feedback.textContent = '‚ùå Mauvaise r√©ponse. La bonne est '+session.current.sol; feedback.className = 'feedback bad';
        const key = session.current.a+'√ó'+session.current.b;
        session.mistakes[key] = (session.mistakes[key]||0) + 1;
      }

      session.history.push({a:session.current.a,b:session.current.b,ans:val,ok,ts:Date.now()});
      if(instantCb.checked || ok || skipped){ nextQuestion(); }
    }

    function finish(){
      if(!session || session.finished) return;
      session.finished = true;
      okBtn.disabled = true; skipBtn.disabled = true;
      play.style.display='none'; resultEl.classList.add('active');

    const asked = session.history.length;
const pct = asked ? Math.round(100*session.good/asked) : 0;
scorePct.textContent = pct;

// üéÜ Feu d‚Äôartifice si 100%
if (pct === 100) {
  showFireworks(5000);
}

totalTime.textContent = fmt(session.elapsed);
tPerQ.textContent = asked ? (session.elapsed/asked/1000).toFixed(1)+' s' : '‚Äî';

      mistakesUl.innerHTML = '';
      const items = Object.entries(session.mistakes).sort((a,b)=>b[1]-a[1]).slice(0,8);
      if(items.length===0){
        const li = document.createElement('li'); li.textContent = 'Aucune erreur ‚Äî super !'; mistakesUl.appendChild(li);
      }else{
        items.forEach(([k,c]) => {
          const li = document.createElement('li'); li.textContent = `${k}  √ó${c}`; mistakesUl.appendChild(li);
        });
      }
    }

    // Events
    startBtn.addEventListener('click', newSession);
    resetBtn.addEventListener('click', ()=>{
      localStorage.removeItem('cm_history');
      localStorage.removeItem('cm_settings');
      // valeurs par d√©faut
      allTables.checked = true; tableChecks().forEach(c=>c.checked=true);
      minB.value = 0; maxB.value = 11; numQ.value = 20; instantCb.checked = true;
      alert('Param√®tres r√©initialis√©s.');
    });
    okBtn.addEventListener('click', ()=>submit(false));
    skipBtn.addEventListener('click', ()=>submit(true));
    answer.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); submit(false);} });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="fireworks.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const intro = document.getElementById('intro');
  if (!intro) return; // intro absent ‚Üí on sort

  const introStartBtn = document.getElementById('introBtn');
  const introSkipBtn  = document.getElementById('skipIntro');
  const SEEN_KEY = 'cm_intro_seen_v1';

  // Si d√©j√† vue, on masque l‚Äôintro
  if (localStorage.getItem(SEEN_KEY)) {
    intro.classList.add('hide');
    return; // rien d'autre √† faire
  }

  function closeIntro(playSound){
    try{
      if (playSound) {
        const audio = new Audio('intro-sound.mp3');
        audio.play().catch(()=>{});
      }
    }catch(e){}
    intro.classList.add('hide');
    localStorage.setItem(SEEN_KEY, '1');
    // focus sur D√©marrer pour encha√Æner
    const start = document.getElementById('startBtn');
    if (start) setTimeout(()=>start.focus({preventScroll:true}), 200);
  }

  introStartBtn && introStartBtn.addEventListener('click', ()=>closeIntro(true));
  introSkipBtn  && introSkipBtn.addEventListener('click', ()=>closeIntro(false));
});
</script>
</body>
</html>
